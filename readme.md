# OSS парсер

Анимированные 3d модели игры "Эадор. Владыки миров" и "Эадор. Империя" имеют расширение *.oss. Это файлы очень простой структуры, они не содержат полноценного скелета, где кости бы привязывались одна к другой, но содержат привязку вертексов к костям, а также безье-кривые анимации для каждой кости - то есть всё готово и заранее просчитано для анимации средствами opengl. 

Так как игры серии "Эадор..." чрезвычайно богаты багами, и слишком медленнные для того, чтобы можно было ими полноценно наслаждаться, некоторое время назад возникла идея - попытаться их перенести на другой движок и переписать логику, для ускорения хода и т.д. В рамках переноса первой из задач стала задача преобразования моделей.

oss_parser решает данную задачу, преобразуя 3d модели формата *.oss из папки ./oss/ в 3d модели формата *.gltf. Для компиляции парсера нужны tinygltf (в моем случае из состава vcpkg) и Visual Studio 2022 Community Edition. Для тестирования рекомендую приобрести GoG-версию игры "Эадор. Владыки миров" и воспользоваться утилитой распаковки ресурсов (например, EadorMBWTools). Кроме того рекомендую скопировать текстуры *.dds и положить их в папку ./oss/, чтобы результат представлял собой текстурированные модели.

Что было бы неплохо добавить в будущем:
1. Поддержку автоматического преобразования моделей в папке с игрой.
2. Устранить редкие дефекты анимации (например, у лучника при преобразовании на одном из кадров странным образом выгибаются пальцы). Дефекты анимации могут быть связаны с тем, что в игре есть неиспользуемые кадры анимации.

Что сделано:
1. Добавлена поддержка карт нормалей.
2. Нашёл 1 ошибку с анимациями. Она ужасна. Анимация кости с номером 0 не отображается, так как anim.channels[0].target_node = 0 не записывается в результирующий файл средствами tinygltf. То есть ошибка не в моём коде, а в коде tinygltf. Нужно вскрывать код tinygltf... Действительно, строка 6970:
```
if (channel.target_node > 0) {
  SerializeNumberProperty("node", channel.target_node, target);
}
```
А должно быть:
```
if (channel.target_node >= 0) {
  SerializeNumberProperty("node", channel.target_node, target);
}
```
3. Добавлен OsmParser для разбора статических osm файлов. Преобразование в gltf вынесено в функции add, чтобы поддерживать файлы с несколькими мешами. Незадокументированный факт - массив JOINTS_N включает номера костей в skin, а не ноды, как описано в документации. Надо запомнить...
4. Добавлена поддержка файлов из папок attach. Теперь отображаются и анимированы лошади, головы, крылья, предметы - всё, что ранее не отображалось.

Пример:
![Пример результата преобразования](./example/example.gif)